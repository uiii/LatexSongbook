--- orig/compat/strmode.c
+++ mod/compat/strmode.c
@@ -58,12 +58,16 @@
 	case S_IFREG:			/* regular */
 		*p++ = '-';
 		break;
+#ifdef S_IFLNK
 	case S_IFLNK:			/* symbolic link */
 		*p++ = 'l';
 		break;
+#endif
+#ifdef S_IFSOCK
 	case S_IFSOCK:			/* socket */
 		*p++ = 's';
 		break;
+#endif
 #ifdef S_IFIFO
 	case S_IFIFO:			/* fifo */
 		*p++ = 'p';
@@ -87,29 +91,40 @@
 		*p++ = 'w';
 	else
 		*p++ = '-';
+#ifdef S_ISUID
 	switch (mode & (S_IXUSR | S_ISUID)) {
+#else
+	switch (mode & (S_IXUSR)) {
+#endif
 	case 0:
 		*p++ = '-';
 		break;
 	case S_IXUSR:
 		*p++ = 'x';
 		break;
+#ifdef S_ISUID
 	case S_ISUID:
 		*p++ = 'S';
 		break;
 	case S_IXUSR | S_ISUID:
 		*p++ = 's';
 		break;
+#endif
 	}
 	/* group */
+#ifdef S_IRGRP
 	if (mode & S_IRGRP)
 		*p++ = 'r';
 	else
+#endif
 		*p++ = '-';
+#ifdef S_IWGRP
 	if (mode & S_IWGRP)
 		*p++ = 'w';
 	else
+#endif
 		*p++ = '-';
+#if defined(S_IXGRP) && defined(S_ISGID)
 	switch (mode & (S_IXGRP | S_ISGID)) {
 	case 0:
 		*p++ = '-';
@@ -124,6 +139,10 @@
 		*p++ = 's';
 		break;
 	}
+#else
+	*p++ = '-';
+#endif
+#ifndef WIN32
 	/* other */
 	if (mode & S_IROTH)
 		*p++ = 'r';
@@ -147,6 +166,11 @@
 		*p++ = 't';
 		break;
 	}
+#else
+	*p++ = '-';
+	*p++ = '-';
+	*p++ = '-';
+#endif
 	*p++ = ' ';		/* will be a '+' if ACL's implemented */
 	*p = '\0';
 }
